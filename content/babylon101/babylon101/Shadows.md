---
ID_PAGE: 22151
PG_TITLE: 17. Shadows
---
## Introduction

В этом уроке мы узнаем, как создавать тени в Babylon JS. Тени теперь становятся динамичными, и теперь они генерируются динамически в зависимости от света.
Вы можете посетить [**the playground scene**]( https://www.babylonjs-playground.com/?15) для этого урока.

## Как я могу это сделать?

Тени легко генерировать, используя babylon.js `ShadowGenerator`. Эта функция использует shadow map: карта вашей сцены, созданная с точки зрения источника света.

Генератор теней использует два параметра: размер карты теней и какой свет используется для вычисления карты теней..
```javascript
var shadowGenerator = new BABYLON.ShadowGenerator(1024, light);
```

Затем вы должны определить, какие тени будут отображаться. Здесь нам нужна тень нашего тора, но вы можете «протолкнуть» любую сетку, какую захотите:
```javascript 
shadowGenerator.getShadowMap().renderList.push(torus);
```

Появившийся с babylon.js v3.1, две новые вспомогательные функции для работы с отбрасыванием теней:
* `addShadowCaster(mesh, includeDescendants)`: Вспомогательная функция для добавления меша и его потомков в список отбрасывателей теней
* `removeShadowCaster(mesh, includeDescendants)`: Вспомогательная функция для удаления меша и его потомков из списка отбрасывателей теней

И, наконец, вам нужно определить, где будут отображаться тени ... установив для параметра сетки значение true:
```javascript
ground.receiveShadows = true;
```

## Soft shadows

Если вы хотите пойти дальше, вы можете активировать фильтрацию теней, чтобы создавать более привлекательные тени, удаляя жесткие края.

Доступны три фильтра:

### Poisson sampling
```javascript
shadowGenerator.usePoissonSampling = true;
```
Если вы установите этот параметр на _true_, карты теней Variance будут отключены. Этот фильтр использует сэмплирование Пуассона для смягчения теней. Результат лучше, но медленнее.

### Exponential shadow map 
```javascript
shadowGenerator.useExponentialShadowMap = true;
```
Это _true_ по умолчанию, потому что это полезно, чтобы уменьшить наложение тени. Но если вы хотите сократить время вычислений, не стесняйтесь выключать его.
Вы также можете управлять тем, как экспоненциальная карта теней масштабирует значения глубины, изменяя `shadowGenerator.depthScale`. По умолчанию это значение равно 50.0, но вы можете изменить его, если шкала глубины вашего мира (расстояние между MinZ и MaxZ) мала.

### Blur exponential shadow map 
```javascript
shadowGenerator.useBlurExponentialShadowMap = true;
```
Это лучше смягчает теневой фильтр, но медленнее. Используется размытая экспоненциальная карта теней.

Качество размытия определяется следующими свойствами:

* `shadowGenerator.blurScale`: Определите масштаб, используемый для уменьшения масштаба карты теней, перед применением постобработки размытия. По умолчанию значение равно 2
* `shadowGenerator.blurBoxOffset`: Определите смещение края поля, используемого для применения размытия. По умолчанию это значение равно 1 (это означает, что поле будет изменяться от -1 до 1 в обоих направлениях, что приведет к 9 значениям, прочитанным постобработкой размытия).
* `shadowGenerator.useKernelBlur`: Вы можете решить использовать размытие ядра вместо размытия окна. В то время как немного дороже, качество тени намного лучше с размытием ядра. Вы можете контролировать размер ядра с помощью `shadowGenerator.blurKernel`, значение по умолчанию которого равно 1.

Вот пример размытых теней: https://www.babylonjs-playground.com/#IIZ9UU

### Close exponential shadow map
Начиная с Babylon.js 3.0, мы представили новый способ создания экспоненциальной карты теней для решения проблем самозатенения:  Close Exponential Shadow Map (CESM).
С CESM, Вы можете получить точное самозатенение, но вам нужно будет определить дополнительные параметры:
* Вы должны предоставить наименьший диапазон значений глубины от вашего освещения, установив `light.shadowMinZ` и `light.shadowMaxZ`. Чем меньше диапазон, тем лучше будет тень.
* Вы должны убедиться, что свет находится как можно ближе к отбрасывателям теней.

Вы можете включить CESM так:
```javascript
shadowGenerator.useCloseExponentialShadowMap = true;
```

или если вы хотите размытые тени:
```javascript
shadowGenerator.useBlurCloseExponentialShadowMap = true;
```

Вот пример того, как CESM работает: https://www.babylonjs-playground.com/#0TG0TB

### Percentage Closer Filtering (Webgl2 only)
Начиная с Babylon.js 3.2, был представлен новый способ работы с картами теней. Это значительно улучшает производительность и настройку теней.

Тени PCF извлекают выгоду из новых функций аппаратной фильтрации, доступных в Webgl2, и обеспечивают более плавную версию сэмплирования Пуассона. Они отступают от стандартной выборки Пуассона, когда Webgl2 недоступен на целевом устройстве.

Вы можете включить PCF так:
```javascript
shadowGenerator.usePercentageCloserFiltering = true;
```

Вот пример того, как работает PCF: https://playground.babylonjs.com/#B48X7G#1

Поскольку PCF требует больше ресурсов, чем может быть доступно на небольших платформах, вы можете использовать свойство  `filteringQuality`, чтобы выбрать лучший компромисс между качеством и производительностью в зависимости от вашего опыта (чем ниже качество, тем выше производительность).

```javascript
shadowGenerator.filteringQuality = BABYLON.ShadowGenerator.QUALITY_LOW;
```

Только точечные и направленные источники света в настоящее время поддерживаются PCF.

### Contact hardening shadow (Webgl2 only)
Начиная с Babylon.js 3.2, были представлены тени с упрочнением контактов на основе теней PCSS..

PCSS можно рассматривать как улучшенную версию PCF, но, несмотря на то, что они выглядят лучше, они также требовательнее к процессору и должны использоваться для настольных приложений. Как и PCF, они автоматически переключаются на выборку Пуассона, если код работает на платформе WebGL 1.

В PCSS тени станут мягче, когда они будут дальше от объекта, который их отбрасывает, имитируя то, что происходит в реальной жизни.

Чтобы получить точный результат, вам необходимо определить дополнительные параметры:
* Вы должны предоставить наименьший диапазон значений глубины от вашего освещения, установив `light.shadowMinZ` и `light.shadowMaxZ`. Чем меньше диапазон, тем лучше будет тень.
* Вы также можете играть со следующим параметром ```contactHardeningLightSizeUVRatio``` чтобы изменить скорость размягчения тени (от 0 до 1).

Вы можете включить PCSS так:
```javascript
shadowGenerator.useContactHardeningShadow = true;
```

Вот пример того, как работает PCSS: https://playground.babylonjs.com/#B48X7G#2

Поскольку PCSS требует больше ресурсов, чем может быть доступно на небольшой платформе, вы можете использовать свойство `filteringQuality`, чтобы выбрать лучший компромисс между качеством и производительностью в зависимости от вашего опыта. (чем ниже качество, тем лучше характеристики).

```javascript
shadowGenerator.filteringQuality = BABYLON.ShadowGenerator.QUALITY_LOW;
```

Следующая ссылка дает хорошее представление о смягчении теней, когда отбрасыватель теней перемещается дальше от объекта, получающего тень.: https://playground.babylonjs.com/#ZT8BKT#2

В данный момент PCSS поддерживает только точечные и направленные источники света..

## Examples

Вы можете найти живой пример здесь: 
https://playground.babylonjs.com/#B48X7G

Здесь вы найдете фотографии различных фильтров, используемых с прожектором:

![Hard shadows](/img/how_to/hardshadows.jpg)

*No filter*

![Poisson](/img/how_to/poisson.jpg)

*Poisson sampling*

![ESM](/img/how_to/esm.jpg)

*Exponential Shadow Map*

![BlurESM](/img/how_to/bluresm.jpg)

*Blur Exponential Shadow Map*

![PCF](/img/how_to/pcfshadows.jpg)

*Percentage Closer Filtering*

![PCSS](/img/how_to/pcssshadows.jpg)

*Contact Hardening Shadow*

## Lights
Имейте в виду, что этот генератор теней можно использовать только с одним источником света. Если вы хотите генерировать тени от другого источника света, то вам нужно будет создать еще один генератор теней.

Только точечные, направленные и точечные источники света могут отбрасывать тени.

### Point lights
В точечных источниках используется рендеринг кубических карт, поэтому будьте осторожны при их включении, так как это может привести к некоторым проблемам с производительностью. Вы также можете посетить [точка света карта теней игровая площадка]( https://www.babylonjs-playground.com/#LYCSQ#12)

Furthermore, `BlurExponentialShadowMap` и `CloseBlurExponentialShadowMap` не поддерживаются точечным освещением (в основном потому, что размытие шести граней кубической карты было бы слишком дорого).

Чтобы оптимизировать рендеринг, вы также можете использовать точечный источник света как неограниченный точечный источник света, если вы уверены, что все отбрасывателей теней находятся на одной стороне источника света. Для этого просто укажите направление для вашего источника света и автоматически Babylon.js будет использовать простую текстуру для карты теней вместо кубической карты.

### Spot lights
Spot lights использует перспективную проекцию для вычисления карты теней.

### Directional lights
Directional lights использует ортогональную проекцию. Положение источника света оценивается автоматически, чтобы вы могли получить наилучшую возможную карту теней. Вы можете контролировать это поведение, поворачивая `light.autoUpdateExtends` off.
Вы также можете контролировать размер окна проекции, изменив одно из этих свойств:
* `light.shadowOrthoScale`: 0.1 по умолчанию это означает, что окно проекции увеличивается на 10% от оптимального размера.
* `light.shadowFrustumSize`: Off по умолчанию со значением 0. Вы можете указать значение, которое будет использоваться для определения размера квадрата усеченного конуса.

Положение источника света, а также положения меша, который вы поместили в список визуализации, определяют, где будут появляться тени. Обратите внимание, что ваша легкая точка зрения с этой позиции должна просматривать все сетки в renderList; в противном случае тени могут не отображаться. See [this example](http://www.babylonjs-playground.com/#R1EVD0#3).

### Customizing the projection matrix
Все источники света должны обеспечивать проекционную матрицу для генераторов теней для построения карты теней. Вы можете определить свою собственную версию, установив `light.customProjectionMatrixBuilder` значение:
```
light.customProjectionMatrixBuilder = function(viewMatrix: Matrix, renderList: Array<AbstractMesh>) {
    return BABYLON.Matrix.PerspectiveFovLH(angle, 1.0, activeCamera.minZ, this.shadowMaxZ);
}
```

## Troubleshooting
Shadow Mapping - отличная техника, но она не идеальна. Несколько параметров могут быть настроены для улучшения окончательного рендеринга.

### Bias
Возможно, вы захотите уменьшить зернистость тени из-за недостаточно точной карты теней. Для этого вы можете определить смещение (по умолчанию 0,00005).:
```javascript
shadowGenerator.bias = 0.01;
```
Shadow generators сравните глубину каждого пикселя с глубиной окклюдеров (теней), видимых с точки зрения света. Поскольку мы имеем дело с текстурами низкой точности (когда поддерживается Babylon.js будет использовать плавающие текстуры, но устройства низкого уровня поддерживают только текстуры int), вы можете увеличить глубину окклюдеров, чтобы упростить самозатенение (объект отбрасывает тени на себя ).

### Рендеринг задней стороны
Вы можете улучшить проблемы с самозатенением, установив для параметра shadowGenerator.forceBackFacesOnly значение true. Это заставит генератор теней рендерить задние грани вашей сетки на карту теней. Это может явно улучшить общую точность и уменьшить необходимость смещения.

### Улучшение точности матрицы проекции
По умолчанию матрица проецирования света использует minZ и maxZ основной камеры. Но вы можете захотеть управлять им, чтобы получить более точную карту теней, уменьшив расстояние между minZ и maxZ. Для этого вы можете установить `light.shadowMinZ` and `light.shadowMaxZ`.

### Use the best option for self-shadowing
Как упоминалось ранее, если вы хотите размытые тени на объекте с самозатенением, лучшим вариантом будет, вероятно, пойти с близкой экспоненциальной картой теней..

### Frustum edge falloff
В зависимости от того, как вы настроили свой генератор теней, вы можете столкнуться со странным падением, когда объект находится вблизи краев карты теней. Чтобы элегантно решить эту проблему, вы можете установить свойство с именем `frustumEdgeFalloff`:

```javascript
 shadowGenerator.frustumEdgeFalloff = 1.0;
```

Вы можете найти пример здесь: https://www.babylonjs-playground.com/#Y5IZCF

Это свойство контролирует степень исчезновения теней на краю усеченного конуса. Он используется только направленным и точечным освещением. По умолчанию установлено значение 0 (без спада) и 1.0 (полное спад).

### Freezing shadows in static world

В случае, если у вас есть статичный игровой мир (объекты, которые отбрасывают тени) - нет необходимости выполнять одни и те же вычисления теней 60 раз в секунду. Этого может быть достаточно для создания и размещения карты теней только один раз. Это значительно повышает производительность, позволяя получить более высокие значения разрешения shadowMap.

Генераторы теней могут быть заморожены с:

```javascript
shadowGenerator.getShadowMap().refreshRate = BABYLON.RenderTargetTexture.REFRESHRATE_RENDER_ONCE;
```

Попросите свет не пересчитывать положение тени с:

```javascript
light.autoUpdateExtends = false;
```

### Очистка матриц весов костей

Неправильный или неточный вес костей анимированного меша может вызвать негативные или странные тени. В этом случае вы можете очистить веса автоматически при загрузке с помощью следующего кода:

```javascript
BABYLON.SceneLoader.CleanBoneMatrixWeights = true;
```

(Вы должны установить это перед загрузкой сцены или мешей.)

### Self Shadow

Вероятно, это тот случай, когда Self-Shadowing требует наибольшего внимания при настройке. Давайте попробуем настроить самозатенение в следующей сцене): https://playground.babylonjs.com/#FH3FM2#1

Первый шаг заключается в добавлении генератора теней в сцену и определении каждой сетки как в роли кастеров, так и в качестве приемников (мы также устанавливаем смещение в 0, чтобы выделить сгенерированные артефакты): https://playground.babylonjs.com/#FH3FM2#4

Как вы можете заметить, на поверхности самозатененных объектов повсюду появляются странные узоры. Это называется зернистостью тени ([more information](http://www.opengl-tutorial.org/intermediate-tutorials/tutorial-16-shadow-mapping/#shadow-acne)).

К счастью, в Babylon у нас есть способ решить проблему.

#### Bias

Как подробно описано в предыдущем [opengl tutorial](http://www.opengl-tutorial.org/intermediate-tutorials/tutorial-16-shadow-mapping/#shadow-acne), Вы можете увеличить значение смещения, чтобы вся зернистость исчезла: https://playground.babylonjs.com/#FH3FM2#5

К сожалению, это приводит к другому побочному эффекту, который называется панорамированием Питера, когда тени больше не прикрепляются к своим объектам..

![PeterPanning](/img/how_to/peterpanning.jpg)

Здесь вы можете воспользоваться функцией BabylonJS 3.2, которая называется нормальным смещением..

#### Normal Bias (Since 3.2)

Сначала вернитесь назад, чтобы быть на пределе, чтобы увидеть артефакты панорамирования Питера.: https://playground.babylonjs.com/#FH3FM2#6

Как вы заметили, теперь на объекте, где поверхность параллельна направлению света, появляется немного зернистости:

![ParallelAcnea](/img/how_to/paralellacnea.jpg)

Это где добавить немного нормального смещения. В основном, во время генерации карты теней, это вставит геометрию в направлении нормали, где поверхность параллельна свету.: https://playground.babylonjs.com/#FH3FM2#7

Все артефакты исчезли, и пришло время, чтобы наши тени выглядели потрясающе.

#### Мягкие тени

Попробуй поменять генератор теней на Закалку контактов: https://playground.babylonjs.com/#FH3FM2#8

Сначала вы не можете видеть эффект затвердевания контактов, и, не только это, вы можете снова увидеть теневые угри. Принимая во внимание раздел о PCSS, вы понимаете, что минимальное и максимальное значения света должны быть установлены как можно ближе: https://playground.babylonjs.com/#FH3FM2#10

Теперь эффект контактного отверждения присутствует, но акне еще сильнее. К сожалению, смещение применяется к нормализованной глубине координат (0-1), поэтому изменение ближнего и дальнего значения света влияет на то, насколько большим должно быть смещение.

Итак, вернитесь назад и измените смещение до максимума, прежде чем увидеть пантерирование Питера, а затем примените некоторое нормальное смещение для удаления остальной части акне, что приводит к следующему результату: https://playground.babylonjs.com/#FH3FM2#11

Ваши тени теперь мягкие, без акне и пантеры.

### Custom shadow map shaders

Начиная с Babylon.js v4.0, вы можете указать свой собственный шейдер для рендеринга карт теней. Чтобы определить этот шейдер, вы можете использовать свойство `shaddowGenerator.customShaderOption`:

```
shadowGenerator.customShaderOptions = {  
  shaderName: "customShadowMap",
  uniforms: ["customWorld"]
}
```

Единственное обязательное значение - shaderName. Но вы также можете добавить:
- attributes: используется для указания дополнительных атрибутов, которые вам нужны в вашем шейдере
- uniforms: используется для указания дополнительных униформ, которые вам нужны в вашем шейдере
- samplers: используется для указания дополнительных сэмплеров, которые вам нужны в вашем шейдере
- defines: используется для указания дополнительных определений, которые вам нужны в вашем шейдере

Генерация карты теней является сложной задачей и требует учета нескольких определений (например, типа карты теней между int и float или необходимости альфа-теста). Рекомендуется проверить текущие шейдеры по умолчанию здесь:
- Vertex:https://github.com/BabylonJS/Babylon.js/blob/master/src/Shaders/shadowMap.vertex.fx
- Fragment: https://github.com/BabylonJS/Babylon.js/blob/master/src/Shaders/shadowMap.fragment.fx

Для того, чтобы обновить ваши собственные формы, вы можете положиться на наблюдаемый `shadowGenerator.onBeforeShadowMapRenderObservable`. Это будет вызываться для вас каждый раз, когда будет отображаться карта теней, и это даст вам текущий скомпилированный эффект.

Вы можете найти полный пример здесь: https://www.babylonjs-playground.com/#IJH4VG#0

## Next step
Теперь, когда вы стали настоящим профессионалом в Babylon.js, возможно, пришло время углубиться в код для управления сложными шейдерами, мешами или текстурами. Our [home menu for our wiki](/) Ваш портал для многих продвинутых тем. Вы также можете принять участие в этом проекте, перейдя на нашу страницу Github: [https://github.com/BabylonJS/Babylon.js](https://github.com/BabylonJS/Babylon.js) а также участвуя в нашем очень активном форуме: [https://forum.babylonjs.com](https://forum.babylonjs.com). See you there.
